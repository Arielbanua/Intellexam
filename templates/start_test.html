{% extends 'index.html' %}

{% block content %}

{% for message in get_flashed_messages() %}
	
<div class="alert alert-warning alert-dismissible fade show" role="alert">
	{{ message }}
	<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

	
{% endfor %}

<h1>Start Test: {{ test.title }}</h1>
<p>Remaining time: <span id="timer"></span></p>

<form id="test-form" action="{{ url_for('submit_test', test_id = test.test_id) }}" method="post">
    {% for question in questions %}
        <h2>Question {{ loop.index }}: {{ question.question_text }}</h2>
        {% if question.question_type == 'multiple-choice' %}
            <ul>
                <li><input type="radio" name="chosen_opt_{{ question.question_id }}" value="1"> {{ question.option1 }}</li>
                <li><input type="radio" name="chosen_opt_{{ question.question_id }}" value="2"> {{ question.option2 }}</li>
                <li><input type="radio" name="chosen_opt_{{ question.question_id }}" value="3"> {{ question.option3 }}</li>
                <li><input type="radio" name="chosen_opt_{{ question.question_id }}" value="4"> {{ question.option4 }}</li>
            </ul>
        {% elif question.question_type == 'essay' %}
            <div class="speech-recognition-container">
                <textarea name="answer_{{ question.question_id }}" readonly></textarea>
                <div class="speech-controls">
                    <button id="start_{{ question.question_id }}">Start</button>
                    <button id="stop_{{ question.question_id }}">Stop</button>
                </div>
                <p id="interim_{{ question.question_id }}"></p>
                <p id="final_{{ question.question_id }}"></p>
                <p id="status" class="lead mt-3 text-light" style="display: none">Listenting ...</p>

                
            </div>
        {% endif %}
    {% endfor %}
    <input type="submit" value="Submit Test">
</form>



<script>
    const startTime = new Date("{{ test.start_date }}");
    const endTime = new Date("{{ test.end_date }}");
    const currentTime = new Date();
    const remainingTime = endTime - currentTime;
  
    const timerElement = document.getElementById("timer");
    const form = document.getElementById("test-form");

    let timeoutId = setTimeout(() => {
        form.submit(); // Submit the form when time runs out
    }, remainingTime);

    let intervalId = setInterval(() => {
        const timeLeft = Math.max(0, remainingTime - (new Date() - startTime));
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        timerElement.textContent = `${minutes} minutes ${seconds} seconds`;

        if (timeLeft <= 0) {
            clearTimeout(timeoutId);
            clearInterval(intervalId);
            form.submit(); // Submit the form when time runs out
        }
    }, 1000);

    if ("webkitSpeechRecognition" in window) {
  const questions = document.querySelectorAll('.speech-recognition-container');

  questions.forEach((questionContainer) => {
      const questionId = questionContainer.querySelector('textarea').name.replace('answer_', '');
      const startButton = questionContainer.querySelector(`#start_${questionId}`);
      const stopButton = questionContainer.querySelector(`#stop_${questionId}`);
      const interimTranscriptElement = questionContainer.querySelector(`#interim_${questionId}`);
      const finalTranscriptElement = questionContainer.querySelector(`#final_${questionId}`);
      const textarea = questionContainer.querySelector(`textarea`);

      let speechRecognition = new webkitSpeechRecognition();
      let finalTranscript = "";
      let interimTranscript = "";

      speechRecognition.continuous = true;
      speechRecognition.interimResults = true;

      speechRecognition.onstart = () => {
          // Show the Status Element
          document.querySelector("#status").style.display = "block";
      };
      speechRecognition.onerror = () => {
          // Hide the Status Element
          document.querySelector("#status").style.display = "none";
      };
      speechRecognition.onend = () => {
          // Hide the Status Element
          document.querySelector("#status").style.display = "none";
      };

      speechRecognition.onresult = (event) => {
          interimTranscript = "";

          for (let i = event.resultIndex; i < event.results.length; ++i) {
              if (event.results[i].isFinal) {
                  finalTranscript += event.results[i][0].transcript;
              } else {
                  interimTranscript += event.results[i][0].transcript;
              }
          }

          interimTranscriptElement.innerHTML = interimTranscript;
          finalTranscriptElement.innerHTML = finalTranscript;
          textarea.value = finalTranscript;
      };

      startButton.onclick = () => {
        event.preventDefault();
          speechRecognition.start();
      };

      stopButton.onclick = () => {
        event.preventDefault();
          speechRecognition.stop();
      };
  });
} else {
  console.log("Speech Recognition Not Available");
}
</script>

{% endblock %}